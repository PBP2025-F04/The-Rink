{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="relative min-h-screen bg-gradient-to-b from-blue-200 via-cyan-100 to-blue-200">
  <!-- Spacer -->
  <div class="h-16"></div>

  <!-- Header -->
  <div class="flex flex-col items-center justify-center mb-8 space-y-2">
    <div class="flex items-center justify-center gap-4">
      <div class="flex items-center justify-center w-8 h-8">
        <i class="fa-solid fa-users text-blue-500 text-4xl"></i>
      </div>
    </div>

    <h1 class="text-4xl md:text-5xl font-extrabold text-cyan-700 text-center mt-10 drop-shadow-sm tracking-tight">
      <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-500">
        Forum Community
      </span>
    </h1>

    <p class="text-lg font-medium text-center mt-3 mb-8 tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-500">
      Where ideas grow, and connections come alive
    </p>

    <!-- Refresh Button -->
    <div class="flex justify-center mb-6">
      <button onclick="refreshPost()" 
        class="flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-blue-500 to-cyan-400 
               hover:from-blue-600 hover:to-cyan-500 text-white font-semibold 
               rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
        <i class="fa-solid fa-rotate-right"></i> Refresh
      </button>
    </div>

    <!-- Search -->
    <div class="flex justify-center mt-2">
      <div class="relative w-full max-w-md transform transition-all duration-300 hover:scale-[1.03] focus-within:scale-[1.03]">
        <input
          id="searchInput"
          type="text"
          placeholder="Search posts by title..."
          class="w-full pl-10 pr-4 py-2 rounded-xl border border-cyan-200 shadow-sm 
                 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 
                 outline-none text-gray-700 placeholder-gray-400 transition-all duration-300 bg-white/70 backdrop-blur-sm"
          oninput="filterBySearch()"
        />
        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-cyan-500"></i>
      </div>
    </div>
  </div>

  <!-- === Layout  === -->
<div class="max-w-7xl mx-auto px-8 py-10 flex flex-col lg:flex-row lg:items-start lg:justify-between gap-10">

  <!-- Leaderboard  -->
  <aside class="lg:w-1/2 w-full rounded-3xl shadow-md border border-cyan-100 
             bg-white/80 backdrop-blur-sm h-fit
             lg:sticky lg:top-28
             overflow-y-auto max-h-[80vh] scrollbar-thin scrollbar-thumb-cyan-300 scrollbar-track-transparent">

    <div class="absolute inset-0 bg-gradient-to-b from-blue-100 via-cyan-50 to-white opacity-70 -z-10"></div>
    <div class="relative p-6">
      <h3 class="text-xl font-extrabold text-cyan-700 mb-5 flex flex-col items-center justify-center gap-2 text-center">
        <i class="fa-regular fa-snowflake text-cyan-400 animate-spin-slow text-2xl"></i>
      <span class="bg-gradient-to-r from-blue-400 to-cyan-500 bg-clip-text text-transparent drop-shadow-sm">
        Top Posts This Week
      </span>
    </h3>
      <div id="top-posts-container" class="pr-2">
  <div id="top-posts-wrapper" class="space-y-6 transition-all duration-300"></div>
</div>
    </div>
  </aside>

    <!-- Forum utama  -->
  <section class="lg:w-1/2 w-full px-6 py-10 bg-gradient-to-b from-blue-100 via-cyan-50 to-white 
                 rounded-3xl shadow-md relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-b from-blue-100 via-cyan-50 to-white opacity-70 -z-10"></div>

      <!-- Post Box -->
      <div id="postBox" class="frosted rounded-2xl shadow-sm border border-purple-100 p-5 mb-6 relative z-10">
        <div class="group border border-cyan-300 rounded-xl overflow-hidden transition-all duration-300 focus-within:ring-2 focus-within:ring-cyan-400 hover:scale-[1.03] hover:shadow-md hover:shadow-cyan-100">
          <input
            id="postInput"
            type="text"
            placeholder="What do you think?"
            class="w-full px-4 py-3 border-b border-cyan-200 outline-none cursor-pointer transition-all duration-200"
            readonly
            onclick="toggleExpandBox()" 
          />

          <!-- Expanded Box -->
          <div id="expandedBox"
            class="overflow-hidden max-h-0 opacity-0 transition-all duration-500 ease-in-out">
            <input id="postTitle" type="text" placeholder="Enter post title..."
              class="w-full px-4 py-3 border-b border-cyan-200 outline-none" />
            <div id="thumbnailPreview" class="hidden p-4 flex justify-center">
              <img id="thumbnailImg" src="" class="max-h-40 rounded-lg shadow" alt="thumbnail preview">
            </div>
            <textarea id="postContent" rows="4" placeholder="Insert a Content in here..."
              class="w-full px-4 py-3 border-b border-cyan-200 outline-none"></textarea>

            <div id="toolbar" class="hidden flex justify-between items-center px-4 pb-3 text-gray-500 transition-all duration-500 ease-out hover:scale-[1.02]">
              <div class="flex items-center gap-2 w-full mr-3">
                <i class="fa-regular fa-image text-cyan-500"></i>
                <input id="thumbnailUrl" type="url" placeholder="Paste image URL here (optional)"
                  class="w-full px-3 py-1 border border-cyan-200 rounded-md outline-none text-sm focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400"
                  oninput="previewImageUrl()" />
              </div>
              <button id="postBtn"
                class="bg-gradient-to-r from-blue-500 to-cyan-400 hover:from-blue-600 hover:to-cyan-500 text-white font-semibold px-4 py-2 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                Post
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Buttons -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex justify-center gap-3 py-3 mb-8">
        <button id="filter-all"
          class="bg-gradient-to-r from-blue-500 to-cyan-400 text-white font-semibold px-4 py-2 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
          All Post
        </button>
        <button id="filter-my"
          class="bg-white border border-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
          My Post
        </button>
      </div>

      <!-- Wrapper  -->
      <div id="post-container" class="flex flex-col gap-6">

      <!-- Daftar Post -->
      <div id="grid" class="flex flex-col gap-6"></div>

      <!-- State Info -->
      <div id="loading" class="hidden bg-white rounded-lg border border-gray-200 p-12 text-center">
        <svg class="animate-spin h-8 w-8 text-purple-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <p class="text-gray-600 mt-3">Loading replies...</p>
      </div>

      <div id="error" class="hidden"></div>

      <div id="empty" class="hidden bg-white rounded-lg border border-gray-200 p-12 text-center">
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Post found</h3>
        <p class="text-gray-500 mb-6">Be the first to share activity with the community.</p>
      </div>

      <!-- Pagination -->
      <div id="pagination-container"
          class="flex justify-center items-center gap-3 mt-8 bg-white/80 backdrop-blur-sm 
                  border border-cyan-100 rounded-xl px-6 py-3 shadow-md text-gray-800 text-base
                  transition-all duration-300">
      <!-- Tombol Prev -->
      <button id="prevBtn"
        class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-400 
              text-white font-semibold shadow-md hover:scale-[1.03] transition-all duration-300 
              disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2">
        <i class="fa-solid fa-angle-left"></i> Prev
      </button>

      <!-- Info Pagination -->
      <p id="pagination-info"
        class="text-gray-700 font-medium bg-cyan-50 px-4 py-2 rounded-lg border border-cyan-100 shadow-sm">
        1‚Äì10 of 50
      </p>

      <!-- Tombol Next -->
      <button id="nextBtn"
        class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-400 
              text-white font-semibold shadow-md hover:scale-[1.03] transition-all duration-300 
              disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2">
        Next <i class="fa-solid fa-angle-right"></i>
      </button>
       </div>
      </div>
    </section>
  </div>
</div>

<!-- Modal Detail Post -->
<div id="postDetailModal"
  class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl w-11/12 max-w-2xl p-6 relative">
    <button onclick="closePostModal()"
      class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
    <div id="postDetailContent" class="mt-2">
      <h2 class="text-2xl font-semibold text-gray-800 mb-2">Loading...</h2>
      <p class="text-gray-600 text-sm mb-4">Please wait...</p>
    </div>
  </div>
</div>

<script>
  
  // Configuration
  const POST_API_ENDPOINT = "{% url 'forum:show_json' %}";
  const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
  
  // DOM Elements
  const loadingSpinner = document.getElementById('loading');
  const errorMessage = document.getElementById('error');
  const emptyStateDisplay = document.getElementById('empty');
  const postGridContainer = document.getElementById('grid');
  const showAllPostButton = document.getElementById('filter-all');
  const showMyPostButton = document.getElementById('filter-my');

  let activeFilter = 'all';
  let allPostData = [];
  let currentPage = 1;
  const perPage = 10;
  
  function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
    loadingSpinner.classList.toggle('hidden', !showLoading);
    errorMessage.classList.toggle('hidden', !showError);
    emptyStateDisplay.classList.toggle('hidden', !showEmpty);
    postGridContainer.classList.toggle('hidden', !showGrid);

    if (showGrid) postGridContainer.className = 'flex flex-col gap-4';
  }

  function updateFilterButtonsAppearance() {
  const activeClass = "bg-gradient-to-r from-blue-500 to-cyan-400 hover:from-blue-600 hover:to-cyan-500 text-white font-semibold px-4 py-2 rounded-md shadow-md transition-all duration-300 transform hover:scale-105"
  const inactiveClass = "bg-white text-gray-700 border border-gray-300 transition-all duration-200 hover:scale-105 hover:shadow-lg hover:shadow-gray-200";
  if (activeFilter === 'all') {
    showAllPostButton.className = `px-4 py-2 rounded-md font-medium transition-colors cursor-pointer ${activeClass}`;
    showMyPostButton.className = `px-4 py-2 rounded-md font-medium transition-colors cursor-pointer ${inactiveClass}`;
  } 
  else {
    showMyPostButton.className = `px-4 py-2 rounded-md font-medium transition-colors cursor-pointer ${activeClass}`;
    showAllPostButton.className = `px-4 py-2 rounded-md font-medium transition-colors cursor-pointer ${inactiveClass}`;
    }
  }

  async function fetchPostFromServer() {
  try {
    displayPageSection({ showLoading: true });

    const response = await fetch(POST_API_ENDPOINT, {
      headers: { 'Accept': 'application/json' },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch post data from server');
    }

    const postData = await response.json();
    allPostData = postData || [];

    if (allPostData.length === 0) {
      displayPageSection({ showEmpty: true });
    } else {
      displayPageSection({ showGrid: true });
      filterPosts();
    }
  } catch (error) {
    console.error('Error loading post:', error);
    displayPageSection({ showError: true });
  }
}

  function buildPost(postItem) {
  const postElement = document.createElement('div');
  postElement.dataset.postId = postItem.id;
  postElement.className =
    'bg-white rounded-xl border border-gray-200 shadow-sm transition-all duration-300 hover:shadow-lg hover:scale-[1.02] p-5 flex flex-col gap-4'; 

  const formattedDate = new Date(postItem.created_at).toLocaleDateString('en-US', {
    year: 'numeric', month: 'short', day: 'numeric'
  });

  const thumbnailHtml = postItem.thumbnail_url
    ? `<img src="${postItem.thumbnail_url}" alt="${postItem.title}" class="w-36 h-36 object-cover rounded-lg border border-gray-200">`
    : `<div class="w-36 h-36 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-sm border">No Image</div>`;

  postElement.innerHTML = `
    <div class="flex flex-row gap-5 items-start">
      ${thumbnailHtml}
      <div class="flex flex-col justify-between flex-1">
        <div>
          <div class="flex justify-between text-sm text-gray-500 mb-1">
            <time>${formattedDate}</time>
            ${
              CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(postItem.user_id)
                ? `<div class="flex gap-3">
                    <button onclick='showEditModal(${JSON.stringify(postItem)})' class="text-gray-600 hover:text-blue-600">‚úèÔ∏è Edit</button>
                    <button onclick='openDeleteModal("${postItem.id}")' class="text-red-500 hover:text-red-600">üóëÔ∏è Delete</button>
                  </div>`
                : ''
            }
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-1">${postItem.title || 'Untitled'}</h3>
          <p class="text-gray-700 text-sm leading-relaxed mb-2">${postItem.content || ''}</p>
        </div>

        <div class="flex justify-between items-center border-t pt-2 text-sm text-gray-500">
          <button onclick="toggleReplyBox(${postItem.id}, event)" 
            class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium">
            <i class="fa-regular fa-comment-dots"></i> Reply
          </button>

          <div class="flex items-center gap-3">
            <button onclick="votePost(${postItem.id}, true, event, 'post')" 
              class="flex items-center gap-1 px-2 py-1 bg-green-50 text-green-600 rounded-md hover:bg-green-100 transition">
                <i class="fa-regular fa-thumbs-up"></i>  
                <span id="post-up-${postItem.id}" class="font-medium">${postItem.upvotes_count || 0}</span>
            </button>

            <button onclick="votePost(${postItem.id}, false, event, 'post')" 
              class="flex items-center gap-1 px-2 py-1 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition">
                <i class="fa-regular fa-thumbs-down"></i>  
                <span id="post-down-${postItem.id}" class="font-medium">${postItem.downvotes_count || 0}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  postElement.innerHTML += `
  <div id="replyBox-${postItem.id}" 
       class="hidden overflow-hidden max-h-0 opacity-0 transition-all duration-500 ease-in-out mt-4">
    <div id="replies-${postItem.id}" class="space-y-3 mb-3">
      <p class="text-gray-500 text-sm">No response yet.</p>
    </div>
    <div class="flex gap-2 mt-2">
      <input id="replyInput-${postItem.id}" type="text" placeholder="Create your reply"
             class="flex-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400">
      <button onclick="sendReply(${postItem.id})"
              class="bg-gradient-to-r from-blue-500 to-cyan-400 hover:from-blue-600 hover:to-cyan-500 
                     text-white font-semibold px-4 py-2 rounded-md shadow-md transition-all duration-300 
                     transform hover:scale-105">
        Send
      </button>
    </div>
  </div>
`;

  return postElement;
}


  function toggleReplyBox(postId, event) {
  if (event) event.stopPropagation();

  const box = document.getElementById(`replyBox-${postId}`);
  if (!box) return;

  const isHidden = box.classList.contains("hidden");

  if (isHidden) {
    box.classList.remove("hidden");
    box.style.maxHeight = box.scrollHeight + "px";
    box.style.opacity = "1";
    loadReplies(postId);
  } else {
    box.style.maxHeight = "0px";
    box.style.opacity = "0";
    setTimeout(() => box.classList.add("hidden"), 300);
  }
}


  function toggleExpandBox() {
  if (!CURRENT_USER_ID) {
    window.location.href = "{% url 'authentication:login' %}?next=/forum/";
    return;
  }

  const box = document.getElementById("expandedBox");
  const toolbar = document.getElementById("toolbar");
  const input = document.getElementById("postInput");
  const isOpen = box.classList.contains("open");

  if (isOpen) {
    box.style.maxHeight = "0px";
    box.style.opacity = "0";
    toolbar.style.opacity = "0";
    toolbar.style.transform = "translateY(8px)";
    input.classList.remove("ring-2", "ring-cyan-300");

    setTimeout(() => {
      toolbar.classList.add("hidden");
      box.classList.remove("open");
    }, 400);
  } else {
    box.classList.remove("max-h-0", "opacity-0", "hidden");
    box.style.display = "block";
    void box.offsetHeight; 
    box.style.maxHeight = box.scrollHeight + 150 + "px";
    box.style.opacity = "1";
    box.classList.add("open");
    input.classList.add("ring-2", "ring-cyan-300");

    toolbar.classList.remove("hidden");
    toolbar.style.display = "flex";
    setTimeout(() => {
      toolbar.style.opacity = "1";
      toolbar.style.transform = "translateY(0)";
    }, 250);

    setTimeout(() => {
      box.style.maxHeight = box.scrollHeight + 150 + "px";
    }, 350);
  }
}

  function getTimeAgo(createdAtStr) {
    const createdAt = new Date(createdAtStr);
    const now = new Date();
    const diff = Math.floor((now.getTime() - createdAt.getTime()) / 1000);
    if (diff < 60) return `${diff}s yang lalu`;
    if (diff < 3600) return `${Math.floor(diff / 60)}m yang lalu`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} jam yang lalu`;
    return `${Math.floor(diff / 86400)} hari yang lalu`;
  }

  async function loadReplies(postId) {
  const container = document.getElementById(`replies-${postId}`);
  container.innerHTML = `<p class="text-gray-400 text-sm">Loading...</p>`;

  try {
    const res = await fetch(`/forum/get-replies/${postId}/`);
    const replies = await res.json();

    if (replies.length === 0) {
      container.innerHTML = `<p class="text-gray-500 text-sm">No response yet.</p>`;
      return;
    }

    container.innerHTML = replies.map(r => {
      const initials = r.author ? r.author[0].toUpperCase() : "U";

      return `
<div id="reply-${r.id}" 
     class="relative bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl p-4 border border-cyan-200 
            shadow-sm hover:shadow-md transition-all duration-300 ease-in-out">
  <div class="flex items-start gap-3">
    <!-- Avatar -->
    <div class="w-9 h-9 flex items-center justify-center rounded-full text-white font-bold 
                bg-gradient-to-r from-cyan-400 to-blue-400 shadow-sm">
      ${initials}
    </div>

    <!-- Content -->
    <div class="flex-1">
      <div class="flex items-center justify-between mb-1">
        <span class="font-semibold text-cyan-700">${r.author}</span>
        <span class="text-xs text-gray-400" data-created-at="${r.created_at}">
          ${getTimeAgo(r.created_at)}
        </span>
      </div>

      <!-- Text reply -->
      <p class="text-gray-800 text-sm mb-3 leading-relaxed" id="reply-content-${r.id}">
        ${r.content}
      </p>

      <!-- Tombol Like / Dislike -->
      <div class="flex items-center gap-3">
        <button onclick="voteReply(${r.id}, true)" 
                class="flex items-center gap-1 px-2 py-1 bg-green-50 text-green-600 rounded-md hover:bg-green-100 transition">
          <i class="fa-regular fa-thumbs-up"></i> 
          <span id="up-reply-${r.id}" class="font-medium">${r.upvotes_count || 0}</span>
        </button>

        <button onclick="voteReply(${r.id}, false)" 
                class="flex items-center gap-1 px-2 py-1 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition">
          <i class="fa-regular fa-thumbs-down"></i> 
          <span id="down-reply-${r.id}" class="font-medium">${r.downvotes_count || 0}</span>
        </button>

        <button onclick="replyToUser('${r.author}', ${r.post_id}, window.event)"
        class="flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-600 rounded-md 
               hover:bg-blue-100 transition">
          <i class="fa-solid fa-reply text-xs"></i>
          <span class="text-sm font-medium">Reply</span>
        </button>
      </div>

      <!-- Tombol Edit/Delete hanya untuk author -->
      ${Number(CURRENT_USER_ID) === Number(r.author_id) ? `
        <div class="absolute bottom-2 right-3 flex gap-3 text-sm">
          <button onclick="showEditReply(${r.id}, '${r.content.replace(/'/g, "\\'")}')" 
            class="text-gray-600 hover:text-blue-600 font-medium transition-all duration-200 transform hover:scale-105 flex items-center gap-1">
            ‚úèÔ∏è Edit
          </button>
         <button onclick="confirmDeleteReply(${r.id}, ${r.post_id})"
            class="text-red-500 hover:text-red-600 font-medium transition-all duration-200 transform hover:scale-105 flex items-center gap-1">
            üóëÔ∏è Delete
          </button>
        </div>
      ` : ''}
    </div>
  </div>
</div>
`;
    }).join('');

  } catch (err) {
    console.error(err);
    container.innerHTML = `<p class="text-red-500 text-sm">Gagal memuat balasan.</p>`;
  }
}

  function confirmDeleteReply(replyId, postId) {
  const overlay = document.createElement("div");
  overlay.className = `
    fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center
    animate-fadeIn
  `;

  overlay.innerHTML = `
    <div class="bg-white rounded-xl shadow-xl w-80 p-5 text-center animate-scaleIn">
      <h3 class="text-lg font-semibold text-gray-800 mb-2">Confirm Delete</h3>
      <p class="text-gray-600 text-sm mb-4">
        Are you sure you want to delete this reply?
      </p>
      <div class="flex justify-center gap-3">
        <button id="cancelDelete" 
          class="px-4 py-2 rounded-md border text-gray-600 hover:bg-gray-100 transition">
          Cancel
        </button>
        <button id="confirmDelete"
          class="px-4 py-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition">
          Delete
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(overlay);

  document.getElementById("cancelDelete").onclick = () => overlay.remove();
  document.getElementById("confirmDelete").onclick = async () => {
    overlay.remove();
    await deleteReply(replyId, postId);
  };
}

  async function sendReply(postId) {
  if (event) event.stopPropagation();
  if (!CURRENT_USER_ID) {
    window.location.href = "{% url 'authentication:login' %}?next=/forum/";
    return;
  }

  const input = document.getElementById(`replyInput-${postId}`);
  const content = input.value.trim();
  if (!content) return;

  const response = await fetch(`/forum/add-reply/${postId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
    body: JSON.stringify({ content }),
  });

  if (response.ok) {
    const newReply = await response.json();
    input.value = "";

    const container = document.getElementById(`replies-${postId}`);
    const initials = newReply.author ? newReply.author[0].toUpperCase() : "U";
    const isAuthor = Number(CURRENT_USER_ID) === Number(newReply.author_id);

    container.insertAdjacentHTML("beforeend", `
<div id="reply-${newReply.id}" 
     class="relative bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl p-4 border border-cyan-200 
            shadow-sm hover:shadow-md transition-all duration-300 ease-in-out">
  <div class="flex items-start gap-3">
    <!-- Avatar -->
    <div class="w-9 h-9 flex items-center justify-center rounded-full text-white font-bold 
                bg-gradient-to-r from-cyan-400 to-blue-400 shadow-sm">
      ${initials}
    </div>

    <!-- Content -->
    <div class="flex-1">
      <div class="flex items-center justify-between mb-1">
        <span class="font-semibold text-cyan-700">${newReply.author}</span>
        <span class="text-xs text-gray-400" data-created-at="${newReply.created_at}">baru saja</span>
      </div>

      <p class="text-gray-800 text-sm mb-3 leading-relaxed" id="reply-content-${newReply.id}">
        ${newReply.content}
      </p>

      <div class="flex items-center gap-3">
        <button onclick="voteReply(${newReply.id}, true)" 
                class="flex items-center gap-1 px-2 py-1 bg-green-50 text-green-600 rounded-md hover:bg-green-100 transition">
          <i class="fa-regular fa-thumbs-up"></i> 
          <span id="up-reply-${newReply.id}" class="font-medium">0</span>
        </button>

        <button onclick="voteReply(${newReply.id}, false)" 
                class="flex items-center gap-1 px-2 py-1 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition">
          <i class="fa-regular fa-thumbs-down"></i> 
          <span id="down-reply-${newReply.id}" class="font-medium">0</span>
        </button>

        <button onclick="replyToUser('${newReply.author}', ${postId}, event)"
        class="flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-600 rounded-md 
               hover:bg-blue-100 transition">
  <i class="fa-solid fa-reply text-xs"></i>
  <span class="text-sm font-medium">Reply</span>
</button>
      </div>

      ${
        isAuthor
          ? `
        <div class="absolute bottom-2 right-3 flex gap-3 text-sm">
          <button onclick="showEditReply(${newReply.id}, '${newReply.content.replace(/'/g, "\\'")}')" 
            class="text-gray-600 hover:text-blue-600 font-medium transition-all duration-200 transform hover:scale-105 flex items-center gap-1">
            ‚úèÔ∏è Edit
          </button>
         <button onclick="confirmDeleteReply(${newReply.id}, ${newReply.post_id})"
            class="text-red-500 hover:text-red-600 font-medium transition-all duration-200 transform hover:scale-105 flex items-center gap-1">
            üóëÔ∏è Delete
          </button>
        </div>
        `
          : ""
      }
    </div>
  </div>
</div>
    `);

    container.scrollTo({ top: container.scrollHeight, behavior: "smooth" });

    const timeLabel = container.querySelector(`[data-created-at="${newReply.created_at}"]`);
    if (timeLabel) timeLabel.textContent = "baru saja";

  } else {
    showToast("Failed", "Tidak bisa kirim reply", "error");
  }
}

async function replyToUser(username, postId, event) {
  if (event) event.stopPropagation();

  const mention = `@${username} `;

  const replyBox = document.getElementById(`replyBox-${postId}`);
  if (replyBox && replyBox.classList.contains("hidden")) {
    toggleReplyBox(postId);
    await new Promise(resolve => setTimeout(resolve, 300));
  }

  let input = document.getElementById(`replyInput-${postId}`);
  if (!input) {
    const expandContainer = document.getElementById(`expand-top-post-${postId}`);
    input = expandContainer ? expandContainer.querySelector(`#replyInput-${postId}`) : null;
  }

  if (!input) return;

  if (!input.value.includes(mention)) input.value = mention + input.value;
  input.focus();
  input.scrollIntoView({ behavior: "smooth", block: "center" });
  setTimeout(() => {
    input.selectionStart = input.selectionEnd = input.value.length;
  }, 10);
}

  async function votePost(id, isUpvote, event, source = 'post') {
  const upEl = document.getElementById(`${source}-up-${id}`);
  const downEl = document.getElementById(`${source}-down-${id}`);
  if (!upEl || !downEl) return;

  let prevUp = Number(upEl.textContent);
  let prevDown = Number(downEl.textContent);

  if (isUpvote) upEl.textContent = prevUp + 1;
  else downEl.textContent = prevDown + 1;
  await new Promise(r => requestAnimationFrame(r));

  const btn = event?.currentTarget || event?.target?.closest("button");
  if (btn) {
    btn.classList.add("scale-110");
    btn.style.transition = "transform 0.15s ease";
    setTimeout(() => btn.classList.remove("scale-110"), 150);
  }

  try {
    const res = await fetch("{% url 'forum:toggle_vote' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      credentials: "include",
      body: JSON.stringify({ type: "post", id, is_upvote: isUpvote }),
    });

    if (res.ok) {
      const data = await res.json();
      upEl.textContent = data.upvotes;
      downEl.textContent = data.downvotes;
    } else {
      upEl.textContent = prevUp;
      downEl.textContent = prevDown;
    }
  } catch {
    upEl.textContent = prevUp;
    downEl.textContent = prevDown;
  }
}



 async function openTopPost(postId, event) {
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }

  const container = document.getElementById(`expand-top-post-${postId}`);
  const isOpen = container.classList.contains("open");

  document.querySelectorAll('[id^="expand-top-post-"]').forEach(div => {
    if (div !== container) {
      div.classList.remove("open");
      div.classList.add("hidden");
      div.innerHTML = "";
      div.style.maxHeight = "";
      div.style.opacity = "";
      div.style.transition = "none";
    }
  });

  if (isOpen) {
    container.classList.remove("open");
    container.classList.add("hidden");
    container.innerHTML = "";
    container.style.maxHeight = "";
    container.style.opacity = "";
    container.style.transition = "none";
    return;
  }

  container.classList.remove("hidden");
  container.classList.add("open");
  container.style.transition = "none";
  container.innerHTML = `<p class="text-gray-400 text-sm px-2">Loading post...</p>`;

  try {
    const res = await fetch(`/forum/get-post/${postId}/`);
    if (!res.ok) throw new Error("Failed to fetch post details");
    const post = await res.json();

    container.innerHTML = `
  <div class="border-t pt-3 mt-3 text-sm text-gray-700">
    <div id="replies-${post.id}" 
         class="max-h-48 overflow-y-auto flex flex-col gap-2 mb-3 border-b pb-3"></div>

    <div class="flex gap-2 mt-3" onclick="event.stopPropagation()">
      <input id="replyInput-${post.id}" type="text" placeholder="Create your reply" 
        class="flex-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400">
      <button onclick="sendReply(${post.id})" 
        class="bg-gradient-to-r from-blue-500 to-cyan-400 hover:from-blue-600 hover:to-cyan-500 
               text-white font-semibold px-4 py-2 rounded-md shadow-md transition-all duration-300 
               transform hover:scale-105">
        Send
      </button>
    </div>
  </div>
`;

    const resReplies = await fetch(`/forum/get-replies/${postId}/`);
    const replies = await resReplies.json();
    const replyBox = document.getElementById(`replies-${post.id}`);

    replyBox.innerHTML = replies.length
      ? replies.map(r => {
          const initials = r.author ? r.author[0].toUpperCase() : "U";
          return `
            <div id="reply-${r.id}"
              class="relative bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl p-4 border border-cyan-200 
                     shadow-sm hover:shadow-md transition-all duration-300 ease-in-out mb-2">
              <div class="flex items-start gap-3">
                <div class="w-9 h-9 flex items-center justify-center rounded-full text-white font-bold 
                            bg-gradient-to-r from-cyan-400 to-blue-400 shadow-sm">${initials}</div>
                <div class="flex-1">
                  <div class="flex items-center justify-between mb-1">
                    <span class="font-semibold text-cyan-700">${r.author}</span>
                    <span class="text-xs text-gray-400">${getTimeAgo(r.created_at)}</span>
                  </div>
                  <p class="text-gray-800 text-sm mb-3 leading-relaxed">${r.content}</p>
                  <div class="flex items-center gap-3">
                    <button onclick="voteReply(${r.id}, true)" 
                      class="flex items-center gap-1 px-2 py-1 bg-green-50 text-green-600 rounded-md hover:bg-green-100 transition">
                      <i class="fa-regular fa-thumbs-up"></i>
                      <span id="up-reply-${r.id}" class="font-medium">${r.upvotes_count || 0}</span>
                    </button>
                    <button onclick="voteReply(${r.id}, false)" 
                      class="flex items-center gap-1 px-2 py-1 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition">
                      <i class="fa-regular fa-thumbs-down"></i>
                      <span id="down-reply-${r.id}" class="font-medium">${r.downvotes_count || 0}</span>
                    </button>
                    <button onclick="replyToUser('${r.author}', ${post.id}, event)"
                      class="flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-600 rounded-md hover:bg-blue-100 transition">
                      <i class="fa-solid fa-reply text-xs"></i> <span class="text-sm font-medium">Reply</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>`;
        }).join("")
      : `<p class="text-gray-500 text-sm">No response yet.</p>`;

  } catch (err) {
    console.error(err);
    container.innerHTML = `<p class="text-red-500 text-sm px-2">Failed to load post.</p>`;
  }
}

  async function voteReply(id, isUpvote) {
  try {
    const res = await fetch("{% url 'forum:toggle_vote' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      credentials: "include",
      body: JSON.stringify({ type: "reply", id, is_upvote: isUpvote }),
    });

    const data = await res.json();
    document.getElementById(`up-reply-${id}`).textContent = data.upvotes;
    document.getElementById(`down-reply-${id}`).textContent = data.downvotes;
  } catch {
    showToast("Error", "Gagal vote reply", "error");
  }
}

  async function deleteReply(replyId, postId) {
  try {
    const res = await fetch(`/forum/delete-reply/${replyId}/`, {
      method: "DELETE",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
    });

    if (res.ok) {
      const replyEl = document.getElementById(`reply-${replyId}`);
      if (replyEl) {
        replyEl.classList.add("opacity-0", "scale-95", "transition", "duration-300");
        setTimeout(() => replyEl.remove(), 300);
      }
      showToast("Deleted", "Reply successfully deleted", "success");
    } else {
      showToast("Error", "Failed to delete reply", "error");
    }
  } catch (error) {
    console.error(error);
    showToast("Error", "An error occurred while deleting the reply.", "error");
  }
}

  function showEditReply(replyId, currentContent) {
  const contentEl = document.getElementById(`reply-content-${replyId}`);
  const original = contentEl.innerText;
  contentEl.innerHTML = `
    <textarea id="edit-text-${replyId}" class="w-full border rounded-md p-2 text-sm">${currentContent}</textarea>
    <div class="flex justify-end gap-2 mt-2">
      <button onclick="cancelEdit(${replyId}, '${original.replace(/'/g, "\\'")}')" class="text-gray-500 text-sm">Cancel</button>
      <button onclick="saveEditReply(${replyId})" class="text-blue-600 text-sm font-semibold">Save</button>
    </div>
  `;
}

  function cancelEdit(replyId, originalText) {
  const contentEl = document.getElementById(`reply-content-${replyId}`);
  contentEl.textContent = originalText;
}

  async function saveEditReply(replyId) {
  const textarea = document.getElementById(`edit-text-${replyId}`);
  const newContent = textarea.value.trim();
  if (!newContent) return;

  const res = await fetch(`/forum/edit-reply/${replyId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
    body: JSON.stringify({ content: newContent }),
  });

  if (res.ok) {
    const data = await res.json();
    const contentEl = document.getElementById(`reply-content-${replyId}`);
    contentEl.textContent = data.content;
    showToast("Edited", "Reply updated successfully", "success");
  } else {
    showToast("Error", "Failed to edit reply", "error");
  }
}

  function filterPosts() {
  updateFilterButtonsAppearance();
  const searchQuery = document.getElementById("searchInput")?.value.toLowerCase() || "";
  const paginationContainer = document.getElementById("pagination-container");

  let filtered = activeFilter === 'all'
    ? allPostData
    : allPostData.filter(p => Number(p.user_id) === Number(CURRENT_USER_ID));

  if (searchQuery) {
    filtered = filtered.filter(p => p.title.toLowerCase().includes(searchQuery));
  }

  currentPage = 1;

  if (!filtered.length) {
    displayPageSection({ showEmpty: true });
    paginationContainer.classList.add("hidden");
    document.getElementById("pagination-info").textContent = "0‚Äì0 of 0";
    document.getElementById("prevBtn").disabled = true;
    document.getElementById("nextBtn").disabled = true;
    return;
  }

  displayPageSection({ showGrid: true });
  paginationContainer.classList.remove("hidden");
  renderPaginatedPostsFiltered(filtered);
}



  function closePostModal() {
  document.getElementById('postDetailModal').classList.add('hidden');
}
  
  function renderPosts(postItems) {
  postGridContainer.innerHTML = '';
  postItems.forEach(p => postGridContainer.appendChild(buildPost(p)));
}


  async function refreshPost() {
  showToast("Refreshing", "Loading latest posts...");
  currentPage = 1;

  const savedFilter = localStorage.getItem("activeFilter") || "all";
  activeFilter = savedFilter;

  await fetchPostFromServer();

  updateFilterButtonsAppearance();
  filterPosts();

  refreshTopPosts();
}

async function refreshTopPosts() {
  const container = document.querySelector("#top-posts-wrapper");
  container.innerHTML = `
    <p class="text-gray-400 text-sm text-center py-3 animate-pulse">
      Refreshing leaderboard...
    </p>`;

  try {
    const res = await fetch("{% url 'forum:get_top_posts_json' %}");
    if (!res.ok) throw new Error("Failed to fetch leaderboard");
    const data = await res.json();
    container.innerHTML = "";

    data.forEach((p, i) => {
      const card = document.createElement("div");
      card.className =
        "bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-lg hover:scale-[1.02] transition-all duration-300 p-5";

      const formattedDate = new Date(p.created_at).toLocaleDateString("en-US", {
        year: "numeric", month: "short", day: "numeric"
      });

      card.innerHTML = `
        <div class="flex flex-row gap-5 items-start">
          ${
            p.thumbnail_url
              ? `<img src="${p.thumbnail_url}" class="w-24 h-24 object-cover rounded-lg border border-cyan-100">`
              : `<div class="w-24 h-24 flex items-center justify-center bg-gray-100 rounded-lg text-gray-400 text-sm border">No Img</div>`
          }

          <div class="flex-1">
            <div class="flex justify-between text-sm text-gray-500 mb-1">
              <time>${formattedDate}</time>
            </div>

            <h4 class="text-lg font-semibold text-gray-900 mb-1">${i + 1}. ${p.title || "Untitled"}</h4>
            <p class="text-gray-700 text-sm leading-relaxed mb-2 line-clamp-2">
              ${p.content || ""}
            </p>

            <div class="flex justify-between items-center border-t pt-2 text-sm text-gray-500">
              <button onclick="openTopPost(${p.id}, event); event.stopPropagation();"
                class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium">
                <i class="fa-regular fa-comment-dots"></i> Reply
              </button>

              <div class="flex items-center gap-3">
                <button onclick="votePost(${p.id}, true, event, 'top'); event.stopPropagation();" 
                  class="flex items-center gap-1 px-2 py-1 bg-green-50 text-green-600 rounded-md hover:bg-green-100 transition">
                  <i class="fa-regular fa-thumbs-up"></i> 
                  <span id="top-up-${p.id}" class="font-medium">${p.total_up || 0}</span>
                </button>

                <button onclick="votePost(${p.id}, false, event, 'top'); event.stopPropagation();" 
                  class="flex items-center gap-1 px-2 py-1 bg-red-50 text-red-600 rounded-md hover:bg-red-100 transition">
                  <i class="fa-regular fa-thumbs-down"></i> 
                  <span id="top-down-${p.id}" class="font-medium">${p.total_down || 0}</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="expand-top-post-${p.id}" class="hidden mt-3 overflow-hidden transition-all duration-500 ease-in-out"></div>
      `;
      container.appendChild(card);
    });
  } catch (err) {
    console.error(err);
    container.innerHTML = `<p class="text-red-500 text-sm text-center py-3">Failed to load leaderboard.</p>`;
  }
}


  function filterBySearch() {
  const query = document.getElementById("searchInput").value.toLowerCase();
  const filtered = allPostData.filter(p =>
    p.title.toLowerCase().includes(query)
  );

  if (!filtered.length) {
    displayPageSection({ showEmpty: true });
  } else {
    renderPosts(filtered);
    displayPageSection({ showGrid: true });
  }

  const info = document.getElementById("pagination-info");
  if (query) {
    info.textContent = `1‚Äì${filtered.length} of ${filtered.length}`;
  } else {
    renderPaginatedPosts();
  }
}

  function jumpToSearchedPost() {
  const query = document.getElementById("searchInput").value.toLowerCase().trim();
  if (!query) return;

  const targetPost = allPostData.find(p => p.title.toLowerCase().includes(query));

  if (targetPost) {
    scrollToPost(targetPost.id);
  } else {
    
  }
}

  function adjustExpandedHeight() {
  const box = document.getElementById("expandedBox");
  if (box.classList.contains("open")) {
    box.style.maxHeight = box.scrollHeight + 100 + "px";
  }
}

  function renderPaginatedPosts() {
  const total = allPostData.length;
  const totalPages = Math.ceil(total / perPage);

  if (total === 0) {
    document.getElementById("pagination-info").textContent = "0‚Äì0 of 0";
    document.getElementById("prevBtn").disabled = true;
    document.getElementById("nextBtn").disabled = true;
    return;
  }

  const start = (currentPage - 1) * perPage;
  const end = Math.min(start + perPage, total);
  const visiblePosts = allPostData.slice(start, end);

  postGridContainer.innerHTML = '';
  visiblePosts.forEach(p => postGridContainer.appendChild(buildPost(p)));

  document.getElementById("pagination-info").textContent = `${start + 1}‚Äì${end} of ${total}`;
  document.getElementById("prevBtn").disabled = currentPage === 1;
  document.getElementById("nextBtn").disabled = currentPage === totalPages;
}

function renderPaginatedPostsFiltered(filteredData) {
  const total = filteredData.length;
  const totalPages = Math.ceil(total / perPage);

  const start = (currentPage - 1) * perPage;
  const end = Math.min(start + perPage, total);
  const visiblePosts = filteredData.slice(start, end);

  postGridContainer.innerHTML = '';
  visiblePosts.forEach(p => postGridContainer.appendChild(buildPost(p)));

  document.getElementById("pagination-info").textContent = `${start + 1}‚Äì${end} of ${total}`;
  document.getElementById("prevBtn").disabled = currentPage === 1;
  document.getElementById("nextBtn").disabled = currentPage === totalPages;
}


  function nextPage() {
  let filtered;
  if (activeFilter === "my") {
    filtered = allPostData.filter(p => Number(p.user_id) === Number(CURRENT_USER_ID));
  } else {
    filtered = allPostData;
  }

  const searchQuery = document.getElementById("searchInput")?.value.toLowerCase() || "";
  if (searchQuery) {
    filtered = filtered.filter(p => p.title.toLowerCase().includes(searchQuery));
  }

  const totalPages = Math.ceil(filtered.length / perPage);
  if (currentPage < totalPages) {
    currentPage++;
    renderPaginatedPostsFiltered(filtered);

    setTimeout(() => {
      const postsOnPage = document.querySelectorAll("#grid > div").length;
      if (postsOnPage < perPage) {
        const lastPost = document.querySelector("#grid > div:last-child");
        if (lastPost) {
          lastPost.scrollIntoView({ behavior: "smooth", block: "end" });
        }
      }
    }, 100);
  }
}

function prevPage() {
  let filtered;

  if (activeFilter === "my") {
    filtered = allPostData.filter(p => Number(p.user_id) === Number(CURRENT_USER_ID));
  } else {
    filtered = allPostData;
  }

  const searchQuery = document.getElementById("searchInput")?.value.toLowerCase() || "";
  if (searchQuery) {
    filtered = filtered.filter(p => p.title.toLowerCase().includes(searchQuery));
  }

  if (currentPage > 1) {
    currentPage--;
    renderPaginatedPostsFiltered(filtered);
  }
}

  setInterval(() => {
    document.querySelectorAll("[data-created-at]").forEach(el => {
      el.textContent = getTimeAgo(el.dataset.createdAt);
    });
  }, 60000);

  // Handle POST submission
  document.getElementById("postBtn").addEventListener("click", async () => {
  const title = document.getElementById("postTitle").value.trim();
  const content = document.getElementById("postContent").value.trim();
  const imageUrl = document.getElementById("thumbnailUrl").value.trim();
  const postBtn = document.getElementById("postBtn");

  if (!title || !content) {
    showToast("Empty", "Please fill in both title and content!", "empty");
    return;
  }

  postBtn.disabled = true;
  postBtn.textContent = "Posted";

  try {
    const response = await fetch("{% url 'forum:add_post' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify({ title, content, thumbnail_url: imageUrl }),
    });

    if (response.ok) {
      const data = await response.json();
      showToast("Post Created", "Your post has been added successfully!", "success");
      document.getElementById("postTitle").value = "";
      document.getElementById("postContent").value = "";
      document.getElementById("thumbnailUrl").value = "";
      document.getElementById("thumbnailPreview").classList.add("hidden");

      toggleExpandBox();
      allPostData.unshift(data);

      filterPosts();

      refreshTopPosts();
    } else {
      showToast("Failed to Post", "Please try again later.", "error");
    }
  } catch (err) {
    console.error("Error posting:", err);
    showToast("Failed to Post", "Please try again later.", "error");
  } finally {
    postBtn.disabled = false;
    postBtn.textContent = "Post";
  }
});
  
  document.getElementById("searchInput").addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    e.preventDefault(); 
    jumpToSearchedPost();
  }
});

  document.getElementById("searchInput").blur();
  
  document.addEventListener('click', e => {
    const modal = document.getElementById('postDetailModal');
    if (modal && !modal.classList.contains('hidden') && e.target === modal) {
      closePostModal();
    }
  });

  // Refresh post list when post added, edited, or deleted
  document.addEventListener('postAdded', fetchPostFromServer);
  document.addEventListener("DOMContentLoaded", refreshTopPosts);

  // ==== FILTER BUTTON EVENT LISTENERS ====
  showAllPostButton.addEventListener('click', e => {
    e.preventDefault();
    activeFilter = 'all';
    localStorage.setItem('activeFilter', 'all');
    filterPosts();
  });

  showMyPostButton.addEventListener('click', e => {
    e.preventDefault();
    activeFilter = 'my';
     localStorage.setItem('activeFilter', 'my'); 
    filterPosts();
  });

  const savedFilter = localStorage.getItem('activeFilter');
  if (savedFilter) {
    activeFilter = savedFilter;
  }

  document.getElementById("nextBtn").addEventListener("click", nextPage);
  document.getElementById("prevBtn").addEventListener("click", prevPage);

  // Load Post sesuai filter terakhir
  fetchPostFromServer().then(() => {
    updateFilterButtonsAppearance();
    filterPosts();
  });
</script>

{% include 'modal.html' %}
{% endblock content%}
