{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'navbar.html' %}
{% include 'modal.html' %}

<section class="max-w-2xl mx-auto px-4 py-10 mt-20">
  <!-- Header -->
  <h1 class="text-3xl font-bold text-purple-700 mb-6">Forum Community</h1>

  <!-- Input "Apa yang kamu pikirkan?" (expandable) -->
  <div id="postBox" class="bg-white rounded-2xl shadow-sm border border-purple-100 p-5 mb-8 transition-all duration-300">
    <!-- Input utama -->
    <input
      id="postInput"
      type="text"
      placeholder="Apa yang kamu pikirkan?"
      class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300 cursor-pointer"
      readonly
      onclick="expandPostBox()"
    />

    <!-- Box tambahan (disembunyikan dulu) -->
    <div id="expandedBox" class="hidden mt-4">
      <textarea
        id="postContent"
        rows="4"
        placeholder="Tulis sesuatu..."
        class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none"
      ></textarea>

      <div class="flex justify-between items-center mt-3">
        <div class="flex items-center gap-3 text-gray-500">
          <button class="hover:text-purple-500 transition"><i class="fa-regular fa-image"></i></button>
          <button class="hover:text-purple-500 transition"><i class="fa-regular fa-face-smile"></i></button>
        </div>

        <button 
          onclick="submitPost()"
          class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-5 py-2 rounded-xl font-semibold hover:opacity-90 transition">
          Posting
        </button>
      </div>
    </div>
  </div>

  <!-- Post List -->
  <div id="grid" class="flex flex-col gap-6">
    {% for post in posts %}
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
      <!-- Header user -->
      <div class="flex items-center mb-3">
        <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-100 text-purple-700 font-bold mr-3">
          {{ post.author.username|slice:":1"|upper }}
        </div>
        <div>
          <p class="font-semibold text-gray-800">{{ post.author.username }}</p>
          <p class="text-sm text-gray-500">{{ post.created_at|timesince }} yang lalu</p>
        </div>
      </div>

      <!-- Konten post -->
      <h2 class="text-lg font-semibold text-gray-900 mb-1">{{ post.title }}</h2>
      <p class="text-gray-700 leading-relaxed mb-4">{{ post.content }}</p>

      <!-- Footer (vote + reply) -->
      <div class="flex items-center justify-between text-gray-500 text-sm font-medium">
        <div class="flex items-center gap-5">
          <button id="upvote-btn-{{ post.id }}" onclick="toggleVote('{{ post.id }}', 'post', true)"
            class="text-gray-400 hover:text-orange-500 transition duration-200">
            ‚¨ÜÔ∏è
          </button>
          <span id="vote-count-{{ post.id }}" class="text-sm font-semibold">
            {{ post.total_upvotes|add:"-"|add:post.total_downvotes }}
          </span>
          <button id="downvote-btn-{{ post.id }}" onclick="toggleVote('{{ post.id }}', 'post', false)"
            class="text-gray-400 hover:text-blue-500 transition duration-200">
            ‚¨áÔ∏è
          </button>
          <button onclick="openPostModal('{{ post.id }}')" class="text-gray-500 hover:text-purple-600 transition">
            üí¨ {{ post.replies.count }}
          </button>
        </div>
        <span class="text-gray-400">‚ù§Ô∏è {{ post.upvotes.count }}</span>
      </div>

      {% if post.replies.all|length > 0 %}
      <div class="mt-4 ml-10 bg-gray-50 rounded-xl p-3 border border-gray-100">
        <p class="text-sm text-gray-700">
          <span class="font-semibold">{{ post.replies.first.author.username }}</span>:
          {{ post.replies.first.content }}
        </p>
        <p class="text-xs text-gray-400 mt-1">{{ post.replies.first.created_at|timesince }} yang lalu</p>
      </div>
      {% endif %}
    </div>
    {% empty %}
    <p class="text-center text-gray-500">Belum ada post di forum ini.</p>
    {% endfor %}
  </div>
</section>

<!-- Loading State -->
<div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
  <svg class="animate-spin h-8 w-8 text-purple-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none"
    viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor"
      d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
  </svg>
  <p class="text-gray-600 mt-3">Loading replies...</p>
</div>

<div id="error" class="hidden"></div>
<div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
  <h3 class="text-lg font-medium text-gray-900 mb-2">No Post found</h3>
  <p class="text-gray-500 mb-6">Be the first to share activity with the community.</p>
</div>

<footer class="bg-gray-900 text-gray-300 py-6 text-center text-sm mt-10">
  <p>&copy; 2025 The Rink Forum ‚Äî Dibangun dengan ‚ù§Ô∏è oleh komunitas.</p>
</footer>

<!-- === SCRIPT ORIGINAL KAMU (DIBIARKAN TIDAK DIUBAH) === -->
<script>
  const post_API_ENDPOINT = "{% url 'forum:show_json' %}";
  const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
  const loadingSpinner = document.getElementById('loading');
  const errorMessage = document.getElementById('error');
  const emptyStateDisplay = document.getElementById('empty');
  const postGridContainer = document.getElementById('grid');

  function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
    loadingSpinner.classList.toggle('hidden', !showLoading);
    errorMessage.classList.toggle('hidden', !showError);
    emptyStateDisplay.classList.toggle('hidden', !showEmpty);
    postGridContainer.classList.toggle('hidden', !showGrid);
  }

  async function fetchPostFromServer() {
    try {
      displayPageSection({ showLoading: true });
      const res = await fetch(post_API_ENDPOINT);
      if (!res.ok) throw new Error();
      const posts = await res.json();
      displayPageSection({ showGrid: true });
      renderPosts(posts);
    } catch {
      displayPageSection({ showError: true });
    }
  }

  document.addEventListener('click', e => {
    const modal = document.getElementById('postDetailModal');
    if (modal && !modal.classList.contains('hidden') && e.target === modal) {
      closepostModal();
    }
  });

  fetchPostFromServer();

  // === Fungsi interaksi baru ===
  function expandPostBox() {
    const box = document.getElementById("expandedBox");
    const input = document.getElementById("postInput");
    box.classList.remove("hidden");
    input.classList.remove("cursor-pointer");
    setTimeout(() => document.getElementById("postContent").focus(), 150);
  }

  function submitPost() {
    const content = document.getElementById("postContent").value.trim();
    if (!content) {
      alert("Tulis sesuatu dulu ya üòä");
      return;
    }
    console.log("Posting:", content);
    document.getElementById("postContent").value = "";
    document.getElementById("expandedBox").classList.add("hidden");
    document.getElementById("postInput").classList.add("cursor-pointer");
    showToast("Sukses!", "Post kamu berhasil dikirim üéâ");
  }
</script>
{% endblock %}
