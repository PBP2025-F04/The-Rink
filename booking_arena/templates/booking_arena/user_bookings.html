{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>My Bookings â€” The Rink</title>
{% endblock meta %}

{% block content %}
<style>
  body {
    background: linear-gradient(180deg, #e0f7ff 0%, #ffffff 100%);
    background-attachment: fixed;
    min-height: 100vh;
  }
  .booking-row {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    transition: background-color 0.2s ease;
  }
  .booking-row:hover {
      background: rgba(255, 255, 255, 0.9);
  }
</style>

<div class="container mx-auto px-4 py-12">
  <h1 class="text-4xl font-bold text-sky-900 mb-8 text-center">My Bookings</h1>

  <div class="bg-white bg-opacity-50 backdrop-filter backdrop-blur-lg rounded-2xl shadow-lg overflow-hidden">
    <table class="min-w-full divide-y divide-sky-200">
      <thead class="bg-sky-50 bg-opacity-80">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-sky-800 uppercase tracking-wider">Date</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-sky-800 uppercase tracking-wider">Time Slot</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-sky-800 uppercase tracking-wider">Arena</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-sky-800 uppercase tracking-wider">Status</th>
          <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-sky-800 uppercase tracking-wider">Action</th>
        </tr>
      </thead>
      <tbody id="booking-list-body">
        {% for booking in bookings %}
          <tr class="booking-row" id="booking-row-{{ booking.id }}">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ booking.date|date:"d M Y" }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
              {{ booking.time_slot.start_time|time:"H:i" }} - {{ booking.time_slot.end_time|time:"H:i" }}
              <span class="text-xs text-gray-500">({{ booking.time_slot.get_day_display }})</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ booking.time_slot.arena.name }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if booking.status == 'Booked' %}
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                  {{ booking.status }}
                </span>
              {% elif booking.status == 'Cancelled' %}
                 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                  {{ booking.status }}
                </span>
              {% else %}
                 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                  {{ booking.status }}
                </span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center">
              {% if booking.status == 'Booked' and booking.date >= timezone.now.date %} {# Hanya bisa batal kalo belum lewat & statusnya Booked #}
                <button
                  hx-post="{% url 'booking_arena:cancel_booking' booking.id %}"
                  hx-target="#booking-row-{{ booking.id }}" {# Target baris ini #}
                  hx-swap="outerHTML" {# Ganti seluruh baris #}
                  hx-confirm="Are you sure you want to cancel this booking?"
                  hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'
                  class="text-red-600 hover:text-red-900 transition duration-150 ease-in-out">
                    Cancel
                </button>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {# Versi baris setelah cancel (opsional, jika ingin diganti bukan dihapus) #}
          {# <tr id="booking-row-{{ booking.id }}" hx-swap-oob="true" class="bg-red-50 text-gray-500 italic">
               <td colspan="5" class="px-6 py-4 text-center">Booking for {{ booking.date|date:"d M Y" }} cancelled.</td>
             </tr> #}
        {% empty %}
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">You have no bookings yet.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// Menangani response JSON dari cancel booking (jika view mengembalikan JSON)
document.body.addEventListener('htmx:afterRequest', function(evt) {
    // Cari header HX-Trigger dari response jika ada
    const trigger = evt.detail.xhr.getResponseHeader("HX-Trigger");
    if(trigger && trigger.includes("bookingCancelled")) {
        try {
            const response = JSON.parse(evt.detail.xhr.responseText);
            if (response.status === 'success') {
                showToast(response.message || 'Booking cancelled!', 'success');
                // Barisnya akan dihandle oleh hx-swap="outerHTML"
            } else {
                 showToast(response.message || 'Failed to cancel booking.', 'danger');
            }
        } catch (e) { console.error("Error processing cancel response:", e); }
    }
});
</script>
{% endblock extra_js %}