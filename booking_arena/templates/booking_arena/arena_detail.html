{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>{{ arena.name }} â€” The Rink</title>
{% endblock meta %}

{% block content %}
<style>
  body {
    background: linear-gradient(180deg, #e0f7ff 0%, #ffffff 100%);
    background-attachment: fixed;
  }

  .arena-container {
    display: flex;
    justify-content: center;
    margin-top: 4rem;
  }

  .arena-card {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(14px);
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
    max-width: 1100px;
    width: 90%;
  }

  .arena-card img {
    width: 100%;
    height: 380px;
    object-fit: cover;
    border-radius: 16px;
  }

  .arena-info h2 {
    margin-top: 1rem;
    font-size: 1.8rem;
    color: #013a63;
  }

  .arena-info p {
    color: #3c5c78;
    margin: 0.25rem 0;
  }

  .booking-card {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    padding: 24px;
    border-radius: 20px;
    box-shadow: 0 6px 20px rgba(0, 102, 153, 0.15);
    text-align: center;
  }

  .booking-card h3 {
    color: #01497c;
    margin-bottom: 1rem;
    font-size: 1.3rem;
    font-weight: 600;
  }

  .booking-card form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .booking-card label {
    font-weight: 600;
    color: #023e8a;
    display: flex;
    flex-direction: column;
    text-align: left;
  }

  .booking-card input {
    margin-top: 4px;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #90e0ef;
    outline: none;
    background: rgba(255, 255, 255, 0.8);
    transition: all 0.2s ease;
  }

  .booking-card input:focus {
    border-color: #00b4d8;
    box-shadow: 0 0 6px rgba(0, 180, 216, 0.4);
  }

  .btn-submit {
    background: linear-gradient(90deg, #00b4d8, #0077b6);
    color: white;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 119, 182, 0.3);
  }

  @media (max-width: 900px) {
    .arena-card {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="arena-container">
  <div class="arena-card">
    <div class="arena-info">
      {% if arena.image %}
      <img src="{{ arena.image.url }}" alt="{{ arena.name }}">
      {% endif %}
      <h2>{{ arena.name }}</h2>
      <p class="muted">{{ arena.location }}</p>
      <p class="muted">Capacity: {{ arena.capacity }}</p>
      <p style="margin-top:10px">{{ arena.description }}</p>
    </div>

    <aside class="booking-card">
      <h3>Book This Arena</h3>
      <form id="book-form" method="post" action="{% url 'booking_arena:ajax_book_arena' arena.pk %}">
        {% csrf_token %}
        <label>Date
          <input type="date" name="date" required>
        </label>
        <label>Start Time
          <input type="time" name="start_time" required>
        </label>
        <label>End Time
          <input type="time" name="end_time" required>
        </label>
        <button class="btn-submit" type="submit">Request Booking</button>
      </form>
    </aside>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('book-form');
  const startInput = form.querySelector('input[name="start_time"]');
  const endInput = form.querySelector('input[name="end_time"]');

  // ðŸ”¹ Atur otomatis minimal 1 jam setelah start_time
  startInput.addEventListener('change', () => {
    const start = startInput.value;
    if (!start) return;

    const [h, m] = start.split(':').map(Number);
    const endDate = new Date();
    endDate.setHours(h + 1, m); // Tambah 1 jam dari start
    const minEnd = endDate.toTimeString().slice(0, 5);
    endInput.min = minEnd;

    // Kalau endTime sebelumnya < minEnd â†’ reset
    if (endInput.value && endInput.value < minEnd) {
      endInput.value = '';
    }
  });

  // ðŸ”¹ Validasi sebelum submit
  form?.addEventListener('submit', function (e) {
    e.preventDefault();
    const action = this.getAttribute('action');
    const fd = new FormData(this);
    const payload = {};
    fd.forEach((v, k) => payload[k] = v);

    const start = payload.start_time;
    const end = payload.end_time;

    if (start && end && end <= start) {
      showToast?.('End time must be at least 1 hour after start time');
      return;
    }

    const [hs, ms] = start.split(':').map(Number);
    const [he, me] = end.split(':').map(Number);
    const diff = (he * 60 + me) - (hs * 60 + ms);

    if (diff < 60) {
      showToast?.('Minimum booking duration is 1 hour');
      return;
    }

    fetch(action, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/) || [])[1]
      },
      body: JSON.stringify(payload)
    })
      .then(async r => {
        const j = await r.json().catch(() => null);
        if (!j) { alert('Server error'); return; }
        if (j.login_required) { alert('Please login'); return; }
        if (j.success) { showToast(j.message); }
        else showToast(j.message || 'Error');
      })
      .catch(() => showToast('Network error'));
  });
});
</script>
{% endblock extra_js %}

