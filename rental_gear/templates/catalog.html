{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Catalog — The Rink</title>
<link rel="stylesheet" href="{% static 'rental_gear/catalog.css' %}">
{% endblock meta %}

{% block content %}
<!-- Hero Section -->
<section class="text-center py-16 bg-gradient-to-b from-blue-50 to-blue-100">
  <div class="container mx-auto px-4">
    <h1 class="text-4xl font-extrabold text-blue-900 mb-4">Our Gear Catalog</h1>
    <p class="text-blue-800 mb-10">Explore top-quality equipment for every ice adventure ❄️</p>

    <!-- Search Bar -->
    <div class="mb-8 flex justify-center">
      <div class="relative w-full sm:w-96">
        <input 
          id="search-bar"
          type="text" 
          placeholder="Search gear..."
          class="w-full px-5 py-3 rounded-full border border-blue-200 bg-white/90 backdrop-blur-md text-blue-900 placeholder-blue-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-300" />
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
          class="absolute right-4 top-3.5 w-5 h-5 text-blue-500 pointer-events-none">
          <path stroke-linecap="round" stroke-linejoin="round" 
                d="m21 21-4.35-4.35m0 0A7.5 7.5 0 1 0 7.5 7.5a7.5 7.5 0 0 0 9.15 9.15z" />
        </svg>
      </div>
    </div>

    <!-- Filter Buttons -->
    <div class="flex flex-wrap justify-center gap-3">
      <button class="filter-btn active px-5 py-2.5 rounded-full bg-blue-600 text-white shadow-md transition" data-category="">All</button>
      <button class="filter-btn px-5 py-2.5 rounded-full bg-blue-200/60 backdrop-blur-sm border border-blue-300 text-blue-900 hover:bg-blue-300/80 transition" data-category="hockey">Hockey</button>
      <button class="filter-btn px-5 py-2.5 rounded-full bg-blue-200/60 backdrop-blur-sm border border-blue-300 text-blue-900 hover:bg-blue-300/80 transition" data-category="curling">Curling</button>
      <button class="filter-btn px-5 py-2.5 rounded-full bg-blue-200/60 backdrop-blur-sm border border-blue-300 text-blue-900 hover:bg-blue-300/80 transition" data-category="ice_skating">Ice Skating</button>
    </div>
  </div>
</section>

<!-- Product Grid -->
<section class="py-16">
  <div class="container mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 px-6 transition-all" id="product-grid">
    {% if gears %}
      {% for gear in gears %}
      <article class="product-card bg-white/80 backdrop-blur-md border border-blue-100 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden animate-fadeInUp">
        {% if gear.image %}
          <img src="{{ gear.image.url }}" alt="{{ gear.name }}" class="w-full h-56 object-cover">
        {% else %}
          <div class="w-full h-56 bg-blue-50 flex items-center justify-center text-blue-300 italic">No Image</div>
        {% endif %}
        <div class="p-5 text-left">
          <h3 class="text-xl font-semibold text-blue-900 mb-1">{{ gear.name }}</h3>
          <p class="text-blue-700 text-sm mb-2">Category: {{ gear.get_category_display }} • Size: {{ gear.size }}</p>
          <div class="text-blue-900 font-bold mb-3">Rp{{ gear.price_per_day }} / day</div>
          <div class="flex gap-3">
            <a href="{% url 'rental_gear:gear_detail' gear.id %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition duration-300">Details</a>
            <form class="ajax-add-to-cart" method="post" action="{% url 'rental_gear:add_to_cart' gear.id %}">
              {% csrf_token %}
              <input type="hidden" name="quantity" value="1">
              <input type="hidden" name="days" value="1">
              <button type="submit" class="bg-blue-50 hover:bg-blue-100 text-blue-800 border border-blue-200 px-4 py-2 rounded-lg text-sm transition duration-300">Add</button>
            </form>
          </div>
        </div>
      </article>
      {% endfor %}
    {% else %}
      <p class="col-span-full text-center text-blue-700 italic">No products available.</p>
    {% endif %}
  </div>
</section>

<!-- Toast -->
<div id="toast" class="hidden fixed bottom-6 right-6 bg-blue-900/90 text-white px-5 py-3 rounded-lg shadow-lg text-sm"></div>
{% endblock content %}

{% block extra_js %}
<style>
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.animate-fadeInUp {
  animation: fadeInUp 0.6s ease-out;
}
</style>

<script>
// === Filter Functionality ===
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');

    const category = this.dataset.category;
    fetch(`{% url 'rental_gear:filter_gear' %}?category=${category}`)
      .then(r => r.text())
      .then(html => {
        const grid = document.getElementById('product-grid');
        grid.innerHTML = html;
        grid.querySelectorAll('article').forEach((el, i) => {
          el.style.animationDelay = `${i * 0.05}s`;
          el.classList.add('animate-fadeInUp');
        });
      });
  });
});


// === Search Functionality ===
document.getElementById('search-bar').addEventListener('input', function() {
  const query = this.value.trim();
  fetch(`{% url 'rental_gear:filter_gear' %}?search=${query}`)
    .then(r => r.text())
    .then(html => {
      const grid = document.getElementById('product-grid');
      grid.innerHTML = html;
      grid.querySelectorAll('article').forEach((el, i) => {
        el.style.animationDelay = `${i * 0.05}s`;
        el.classList.add('animate-fadeInUp');
      });
    });
});

// === Toast & Cart ===
function getCookie(name) {
  const cookieValue = document.cookie.split('; ').find(row => row.startsWith(name + '='));
  return cookieValue ? decodeURIComponent(cookieValue.split('=')[1]) : null;
}

function showToast(message, timeout=3000){
  const t = document.getElementById('toast');
  t.innerHTML = message;
  t.classList.remove('hidden');
  setTimeout(()=> t.classList.add('hidden'), timeout);
}

document.querySelectorAll('.ajax-add-to-cart').forEach(f=>{
  f.addEventListener('submit', e=>{
    e.preventDefault();
    const action = f.getAttribute('action');
    fetch(action.replace('/cart/add/','/cart/add-ajax/'), {
      method:'POST',
      headers:{'X-CSRFToken':getCookie('csrftoken')}
    }).then(async r=>{
      const j = await r.json().catch(()=>null);
      if(!j){ showToast('Response error'); return; }
      if(j.login_required){
        showToast('Login required — <a style="color:#ffd" href="/accounts/login/?next='+location.pathname+'">Login</a>', 6000);
        return;
      }
      showToast(j.message || 'Added to cart!');
    });
  });
});
</script>
{% endblock extra_js %}
