{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Catalog — The Rink</title>
<link rel="stylesheet" href="{% static 'rental_gear/catalog.css' %}">
{% endblock meta %}

{% block content %}
<!-- Hero Section -->
<section class="text-center py-16 bg-gradient-to-b from-blue-50 via-blue-100 to-sky-200">
  <div class="container mx-auto px-4">
    <h1 class="text-4xl font-extrabold text-sky-900 mb-4 drop-shadow-sm">Our Gear Catalog</h1>
    <p class="text-sky-800 mb-6">Glide through our premium ice gear ❄️</p>
    
    {% if user.is_superuser %}
    <div class="mb-6">
      <a href="{% url 'rental_gear:create_gear' %}" class="bg-gradient-to-r from-sky-500 to-blue-500 text-white px-5 py-2 rounded-full hover:from-sky-600 hover:to-blue-600 transition-all shadow-lg">Add New Equipment</a>
    </div>
    {% endif %}

    <!-- Search Bar -->
    <div class="mb-8 flex justify-center">
      <div class="relative w-full sm:w-96">
        <input 
          id="search-bar"
          type="text" 
          placeholder="Search gear..."
          class="w-full px-5 py-3 rounded-full border border-sky-200 bg-white/70 backdrop-blur-lg text-sky-900 placeholder-sky-400 shadow-md focus:outline-none focus:ring-2 focus:ring-sky-400 transition-all duration-300" />
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
          class="absolute right-4 top-3.5 w-5 h-5 text-sky-500 pointer-events-none">
          <path stroke-linecap="round" stroke-linejoin="round" 
                d="m21 21-4.35-4.35m0 0A7.5 7.5 0 1 0 7.5 7.5a7.5 7.5 0 0 0 9.15 9.15z" />
        </svg>
      </div>
    </div>

    <!-- Filter Buttons -->
    <div class="flex flex-wrap justify-center gap-3">
      <button class="filter-btn active px-5 py-2.5 rounded-full bg-sky-600 text-white shadow-md transition" data-category="">All</button>
      <button class="filter-btn px-5 py-2.5 rounded-full bg-sky-100 backdrop-blur-sm border border-sky-300 text-sky-900 hover:bg-sky-200 transition" data-category="hockey">Hockey</button>
      <button class="filter-btn px-5 py-2.5 rounded-full bg-sky-100 backdrop-blur-sm border border-sky-300 text-sky-900 hover:bg-sky-200 transition" data-category="curling">Curling</button>
      <button class="filter-btn px-5 py-2.5 rounded-full bg-sky-100 backdrop-blur-sm border border-sky-300 text-sky-900 hover:bg-sky-200 transition" data-category="ice_skating">Ice Skating</button>
    </div>
  </div>
</section>

<!-- Featured Gear Section -->
<section class="py-20 bg-gradient-to-b from-sky-50 to-sky-100">
  <div class="container mx-auto text-center mb-12 fade-up delay-1">
    <h2 class="text-3xl font-bold text-sky-900 mb-4">Featured Gear</h2>
    <p class="text-sky-700">Top picks from our premium collection</p>
  </div>

  <div class="relative container mx-auto px-4 md:px-8 py-6 bg-white/70 backdrop-blur-lg rounded-3xl shadow-inner overflow-hidden">
    <!-- Left arrow -->
    <button id="scrollLeftCatalog"
      class="hidden md:flex absolute left-4 top-1/2 -translate-y-1/2 bg-white shadow-lg rounded-full w-10 h-10 items-center justify-center hover:bg-sky-100 transition z-10">
      ❮
    </button>

    <!-- Right arrow -->
    <button id="scrollRightCatalog"
      class="hidden md:flex absolute right-4 top-1/2 -translate-y-1/2 bg-white shadow-lg rounded-full w-10 h-10 items-center justify-center hover:bg-sky-100 transition z-10">
      ❯
    </button>

    <!-- Scrollable container -->
    <div id="gearScrollCatalog" class="relative overflow-x-auto scroll-smooth flex-nowrap px-2 md:px-6 py-4">
      <div class="flex gap-6 snap-x snap-mandatory pb-6 items-stretch">
{% for gear in featured_gears %}
<div class="fade-up snap-start shrink-0 w-72" style="transition-delay: {{ forloop.counter|add:'0.1'|floatformat:1 }}s;">
  <article class="bg-white border border-sky-100 rounded-2xl shadow-md overflow-hidden hover:shadow-lg transition duration-300 w-full h-full flex flex-col">
    <!-- Gambar -->
    <div class="h-56 overflow-hidden flex-shrink-0">
      {% if gear.image %}
        <img src="{{ gear.image.url }}" alt="{{ gear.name }}" class="w-full h-full object-cover" />
      {% else %}
        <div class="w-full h-full bg-sky-200 flex items-center justify-center text-sky-700">No Image</div>
      {% endif %}
    </div>

    <!-- Konten teks -->
    <div class="p-6 flex flex-col justify-between flex-grow text-left gear-card-content">
      <div class="gear-info">
        <!-- Nama -->
        <h3 class="text-lg font-semibold text-sky-900 gear-name min-h-[3rem] leading-tight mb-1">
          {{ gear.name }}
        </h3>

        <!-- Category dan harga (selalu sejajar) -->
        <div class="gear-meta mt-auto">
          <p class="text-sky-700 text-sm gear-category min-h-[1.5rem] mb-1">
            Category: {{ gear.get_category_display }}
          </p>
          <div class="font-bold text-sky-800 gear-price min-h-[1.5rem]">
            ${{ gear.price_per_day }}
          </div>
        </div>
      </div>

      <!-- Tombol -->
      <div class="flex gap-3 mt-4">
        <a href="{% url 'rental_gear:gear_detail' gear.id %}"
           class="bg-sky-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-sky-700">Detail</a>
        <form method="post" action="{% url 'rental_gear:add_to_cart' gear.id %}" class="inline">
          {% csrf_token %}
          <input type="hidden" name="quantity" value="1">
          <input type="hidden" name="days" value="1">
          <button type="submit"
                  class="bg-sky-100 text-sky-700 px-4 py-2 rounded-lg text-sm hover:bg-sky-200">Add</button>
        </form>
      </div>
    </div>
  </article>
</div>
{% empty %}
<div class="w-full flex justify-center items-center py-10">
  <p class="text-sky-800 text-center">No featured items available.</p>
</div>
{% endfor %}


      </div>
    </div>
  </div>
</section>

<!-- Product Grid -->
<section class="py-16 bg-gradient-to-b from-sky-100 via-blue-50 to-white">
  <div class="container mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 px-6 transition-all" id="product-grid">
    {% if gears %}
      {% for gear in gears %}
      <article class="product-card relative border border-sky-100 rounded-2xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 bg-gradient-to-b from-white/90 to-sky-50/90 backdrop-blur-md flex flex-col justify-between">
        {% if gear.image %}
          <img src="{{ gear.image.url }}" alt="{{ gear.name }}" class="w-full h-56 object-cover">
        {% else %}
          <div class="w-full h-56 bg-sky-50 flex items-center justify-center text-sky-300 italic">No Image</div>
        {% endif %}
        <div class="p-5 flex flex-col justify-between flex-grow">
          <div>
            <h3 class="text-xl font-semibold text-sky-900 mb-1 line-clamp-4 min-h-[4.8em] leading-snug">{{ gear.name }}</h3>
            <p class="text-sky-700 text-sm mb-2">Category: {{ gear.get_category_display }} • Size: {{ gear.size }}</p>
            <div class="text-sky-900 font-bold mb-3">${{ gear.price_per_day }} / day</div>
          </div>
          <div class="mt-auto">
            <div class="grid grid-cols-2 gap-2">
              <a href="{% url 'rental_gear:gear_detail' gear.id %}" class="flex items-center justify-center h-10 bg-sky-600 hover:bg-sky-700 text-white px-4 rounded-lg text-sm transition duration-300 shadow-sm">Details</a>
              <form class="ajax-add-to-cart h-10" method="post" action="{% url 'rental_gear:add_to_cart' gear.id %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <input type="hidden" name="days" value="1">
                <button type="submit" class="w-full h-full bg-sky-50 hover:bg-sky-100 text-sky-800 border border-sky-200 px-4 rounded-lg text-sm transition duration-300 shadow-sm">Add To Cart</button>
              </form>
            </div>
            {% if user.is_superuser %}
            <div class="grid grid-cols-2 gap-2 mt-2">
              <a href="{% url 'rental_gear:update_gear' gear.id %}" class="flex items-center justify-center h-10 bg-yellow-400 hover:bg-yellow-500 text-white rounded-lg text-sm transition duration-300">Edit</a>
              <a href="{% url 'rental_gear:delete_gear' gear.id %}" class="flex items-center justify-center h-10 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition duration-300">Delete</a>
            </div>
            {% endif %}
          </div>
        </div>
      </article>
      {% endfor %}
    {% else %}
      <p class="col-span-full text-center text-sky-700 italic">No products available.</p>
    {% endif %}
  </div>
</section>

<!-- Toast -->
<div id="toast" class="hidden fixed bottom-6 right-6 bg-sky-900/90 text-white px-5 py-3 rounded-lg shadow-lg text-sm"></div>
{% endblock content %}

{% block extra_js %}
<style>
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fadeInUp { animation: fadeInUp 0.6s ease-out; }

.line-clamp-4 {
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Custom Scrollbar for Carousel */
#gearScrollCatalog::-webkit-scrollbar {
  height: 8px;
}

#gearScrollCatalog::-webkit-scrollbar-track {
  background: rgba(14, 165, 233, 0.1); /* Light sky blue */
  border-radius: 4px;
}

#gearScrollCatalog::-webkit-scrollbar-thumb {
  background: linear-gradient(90deg, #0ea5e9, #3b82f6); /* Sky to blue gradient */
  border-radius: 4px;
}

#gearScrollCatalog::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(90deg, #0284c7, #2563eb); /* Darker on hover */
}
</style>

<script>
// === Fade-up Animation ===
document.addEventListener("DOMContentLoaded", function() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add("visible");
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.2 });

  document.querySelectorAll('.fade-up').forEach(el => observer.observe(el));

  // === Featured Gear Carousel ===
  const scrollContainer = document.getElementById("gearScrollCatalog");
  const btnLeft = document.getElementById("scrollLeftCatalog");
  const btnRight = document.getElementById("scrollRightCatalog");

  const scrollAmount = 300;
  let autoScrollInterval;

  btnLeft.addEventListener("click", () => {
    scrollContainer.scrollBy({ left: -scrollAmount, behavior: "smooth" });
    resetAutoScroll();
  });

  btnRight.addEventListener("click", () => {
    scrollContainer.scrollBy({ left: scrollAmount, behavior: "smooth" });
    resetAutoScroll();
  });

  const updateButtons = () => {
    btnLeft.style.opacity = scrollContainer.scrollLeft > 0 ? "1" : "0.3";
    btnRight.style.opacity =
      scrollContainer.scrollLeft + scrollContainer.clientWidth < scrollContainer.scrollWidth
        ? "1"
        : "0.3";
  };

  scrollContainer.addEventListener("scroll", updateButtons);
  updateButtons();

  function startAutoScroll() {
    autoScrollInterval = setInterval(() => {
      const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
      if (scrollContainer.scrollLeft >= maxScroll - 5) {
        scrollContainer.scrollTo({ left: 0, behavior: "smooth" });
      } else {
        scrollContainer.scrollBy({ left: scrollAmount, behavior: "smooth" });
      }
    }, 3000);
  }

  function resetAutoScroll() {
    clearInterval(autoScrollInterval);
    startAutoScroll();
  }

  scrollContainer.addEventListener("mouseenter", () => clearInterval(autoScrollInterval));
  scrollContainer.addEventListener("mouseleave", startAutoScroll);

  startAutoScroll();
});

// === Filter Functionality ===
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');

    const category = this.dataset.category;
    fetch(`{% url 'rental_gear:filter_gear' %}?category=${category}`)
      .then(r => r.text())
      .then(html => {
        const grid = document.getElementById('product-grid');
        grid.innerHTML = html;
        grid.querySelectorAll('article').forEach((el, i) => {
          el.style.animationDelay = `${i * 0.05}s`;
          el.classList.add('animate-fadeInUp');
        });
      });
  });
});

// === Search Functionality ===
document.getElementById('search-bar').addEventListener('input', function() {
  const query = this.value.trim();
  fetch(`{% url 'rental_gear:filter_gear' %}?search=${query}`)
    .then(r => r.text())
    .then(html => {
      const grid = document.getElementById('product-grid');
      grid.innerHTML = html;
      grid.querySelectorAll('article').forEach((el, i) => {
        el.style.animationDelay = `${i * 0.05}s`;
        el.classList.add('animate-fadeInUp');
      });
    });
});

// === Toast & Cart ===
function getCookie(name) {
  const cookieValue = document.cookie.split('; ').find(row => row.startsWith(name + '='));
  return cookieValue ? decodeURIComponent(cookieValue.split('=')[1]) : null;
}

function showToast(message, timeout=3000){
  const t = document.getElementById('toast');
  t.innerHTML = message;
  t.classList.remove('hidden');
  setTimeout(()=> t.classList.add('hidden'), timeout);
}

document.querySelectorAll('.ajax-add-to-cart').forEach(f=>{
  f.addEventListener('submit', e=>{
    e.preventDefault();
    const action = f.getAttribute('action');
    fetch(action.replace('/cart/add/','/cart/add-ajax/'), {
      method:'POST',
      headers:{'X-CSRFToken':getCookie('csrftoken')}
    }).then(async r=>{
      const j = await r.json().catch(()=>null);
      if(!j){ showToast('Response error'); return; }
      if(j.login_required){
        showToast('Login required — <a style="color:#ffd" href="/accounts/login/?next='+location.pathname+'">Login</a>', 6000);
        return;
      }
      showToast(j.message || 'Added to cart!');
    });
  });
});
</script>
{% endblock extra_js %}
