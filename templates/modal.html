<div id="crudModal" data-mode="create" data-edit-id=""
  class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="crudModaldescription"
  class="relative bg-white/80 backdrop-blur-lg rounded-2xl shadow-[0_4px_30px_rgba(0,0,0,0.08)] 
         w-[90%] sm:w-[70%] md:w-[45%] lg:w-[34%] xl:w-[28%]
         border border-cyan-200/60
         transition-all duration-500 opacity-0 translate-y-8 scale-95">
  <div class="absolute inset-0 bg-gradient-to-b from-blue-50 via-cyan-50 to-white opacity-70 -z-10"></div>






    <!-- Header -->
<div class="flex flex-col items-center justify-center p-6 border-b bg-gradient-to-b from-cyan-50 to-white">
  <h3 id="modalTitle" 
      class="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text 
             bg-gradient-to-r from-blue-500 to-cyan-500 drop-shadow-sm text-center tracking-tight">
    Edit Post
  </h3>
  <p id="modalSubtitle" 
     class="text-sm md:text-base text-gray-600 mt-2 text-center font-medium">
    Update your post details
  </p>
</div>


    <!-- Body -->
    <div class="px-6 py-4 space-y-6 form-style">
      <form id="postForm">
        {% csrf_token %}
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Title</label>
          <input type="text" id="title" name="title"
  class="mt-1 block w-full border border-cyan-200 rounded-xl px-4 py-2 
         bg-white/80 backdrop-blur-sm focus:ring-2 focus:ring-cyan-400 
         outline-none transition-all duration-200 hover:scale-[1.01]" required>

        </div>

        <div class="mb-4">
          <label>Content</label>
          <textarea id="content" name="content" rows="3"
  class="mt-1 block w-full border border-cyan-200 rounded-xl px-4 py-2 
         bg-white/80 backdrop-blur-sm focus:ring-2 focus:ring-cyan-400 
         outline-none transition-all duration-200 hover:scale-[1.01]" required></textarea>

        </div>

        <div class="mb-4">
          <label>Thumbnail URL</label>
          <input type="url" id="thumbnail" name="thumbnail"
  class="mt-1 block w-full border border-cyan-200 rounded-xl px-4 py-2 
         bg-white/80 backdrop-blur-sm focus:ring-2 focus:ring-cyan-400 
         outline-none transition-all duration-200 hover:scale-[1.01]">

        </div>

      </form>
    </div>

   <!-- Footer -->
<div class="flex justify-center items-center gap-3 p-4 border-t border-gray-200 rounded-b">
  <button type="submit" id="submitPost" form="postForm"
    class="bg-gradient-to-r from-cyan-400 to-blue-600 text-white 
           px-5 py-2.5 rounded-lg font-semibold shadow-md 
           hover:from-cyan-300 hover:to-blue-500 hover:shadow-lg 
           transform hover:scale-105 transition-all duration-200">
    Save Changes
  </button>
  <button type="button" onclick="hideModal()"
    class="px-5 py-2.5 border border-gray-300 text-gray-700 bg-white 
           rounded-lg font-medium hover:bg-gray-100 transform hover:scale-105 
           transition-all duration-200">
    Cancel
  </button>
</div>



  </div>
</div>

<div id="deleteModal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div class="bg-white p-6 rounded-lg shadow-md w-80">
    <h3 class="text-lg font-semibold mb-4">Delete Post</h3>
    <p class="text-gray-600 mb-6">Are you sure to delete this post?</p>
    <div class="flex justify-end gap-3">
      <button onclick="hideDeleteModal()"
        class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
      <button id="confirmDeleteBtn"
        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

<script>
  function showModal() {
  const modal = document.getElementById('crudModal');
  const modalDesc = document.getElementById('crudModaldescription');
  const title = document.getElementById('modalTitle');
  const subtitle = document.getElementById('modalSubtitle');
  const submitBtn = document.getElementById('submitPost');

  modal.dataset.mode = "create";
  modal.dataset.editId = "";
  document.getElementById("postForm").reset();

  title.textContent = "Create New Post";
  subtitle.textContent = "Share your expression with the community";
  submitBtn.textContent = "Create Post";

  modal.classList.remove('hidden');
  setTimeout(() => {
    modalDesc.classList.remove('opacity-0', 'translate-y-8', 'scale-95');
    modalDesc.classList.add('opacity-100', 'translate-y-0', 'scale-100');
  }, 10);
}


  function showEditModal(post) {
  const modal = document.getElementById('crudModal');
  const modalDesc = document.getElementById('crudModaldescription');
  const title = document.getElementById('modalTitle');
  const subtitle = document.getElementById('modalSubtitle');
  const submitBtn = document.getElementById('submitPost');

  document.getElementById("postForm").reset();
  modal.dataset.mode = "edit";
  modal.dataset.editId = post.id;

  document.getElementById("title").value = post.title || "";
  document.getElementById("content").value = post.content || "";
  document.getElementById("thumbnail").value = post.thumbnail_url || "";

  title.textContent = "Edit Post";
  subtitle.textContent = "Update your post details";
  submitBtn.textContent = "Save Changes";

  modal.classList.remove('hidden');
  setTimeout(() => {
    modalDesc.classList.remove('opacity-0', 'translate-y-8', 'scale-95');
    modalDesc.classList.add('opacity-100', 'translate-y-0', 'scale-100');
  }, 10);
}



  function hideModal() {
  const modal = document.getElementById('crudModal');
  const modalDesc = document.getElementById('crudModaldescription');

  modalDesc.classList.remove('opacity-100', 'translate-y-0', 'scale-100');
  modalDesc.classList.add('opacity-0', 'translate-y-8', 'scale-95');

  setTimeout(() => {
    modal.classList.add('hidden');
    document.getElementById("postForm").reset();
    modal.dataset.mode = "create";
    modal.dataset.editId = "";
  }, 300);
}



    document.getElementById("postForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const modal = document.getElementById('crudModal');
  const mode = modal.dataset.mode;
  const formData = new FormData(e.target);

  const title = formData.get("title");
  const content = formData.get("content");
  const thumbnail = formData.get("thumbnail");

  const data = { title, content, thumbnail };

  let url = "";
  let successMsg = "";

  if (mode === "create") {
  url = "{% url 'forum:add_post' %}";
  successMsg = "Post Created successfully!";
  } else {
    const editId = modal.dataset.editId;
    url = "{% url 'forum:edit_post' 0 %}".replace("0", editId);
    successMsg = "Post updated successfully!";
  }

  const response = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
    body: JSON.stringify(data),
  });

  if (response.ok) {
    hideModal();
    showToast(successMsg, '', 'success');
    document.dispatchEvent(new CustomEvent('postAdded'));
  } else {
    showToast("Failed to submit post ðŸ˜¢", '', 'error');
  }
});


  let postToDelete = null;
  function openDeleteModal(id) {
    postToDelete = id;
    document.getElementById('deleteModal').classList.remove('hidden');
  }

  function hideDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    postToDelete = null;
  }

  document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
  if (!postToDelete) return;

  const postCard = document.querySelector(`[data-post-id="${postToDelete}"]`);

  const response = await fetch(`/forum/delete-post/${postToDelete}/`, {
    method: "DELETE",
    headers: {
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
  });

  if (response.ok) {
      // âœ… Hapus langsung dari array tanpa refresh server
    allPostData = allPostData.filter(p => p.id !== Number(postToDelete));
  if (postCard) {
    postCard.classList.add('opacity-0', 'translate-y-2');
    setTimeout(() => postCard.remove(), 300);
  }
  hideDeleteModal();
  showToast("Post deleted successfully!", '', 'success');

  // âœ… Render ulang sesuai filter aktif
  if (activeFilter === 'my') {
    filterPosts(); // tetap di My Post
  } else {
    fetchPostFromServer(); // kalau lagi di All Post, refresh semua
  }
} else {
  showToast("Failed to delete post ðŸ˜¢", '', 'error');
}
});

</script>
